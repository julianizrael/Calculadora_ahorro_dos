<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Ahorro e Inversi√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Variables y Reset B√°sico */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #dc2626;
            --bg: #ffffff;
            --text-color: #1e293b;
            --bg-alt: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);

            /* Dark Mode Variables */
            --dark-bg: #0f172a;
            --dark-bg-alt: #1e293b;
            --dark-text-color: #f1f5f9;
            --dark-border: #334155;
        }

        /* Dark Mode */
        body.night {
            background-color: var(--dark-bg);
            color: var(--dark-text-color);
        }

        body.night .header h1,
        body.night .tab,
        body.night .tab-content,
        body.night .resume-card,
        body.night .controls button,
        body.night table {
            color: var(--dark-text-color);
        }

        body.night input[type="number"] {
            background: var(--dark-bg);
            border-color: var(--dark-border);
            color: var(--dark-text-color);
        }

        body.night .tab:not(.active) {
            background-color: var(--dark-bg-alt);
        }

        body.night .tab-content,
        body.night .resume-card {
            background-color: var(--dark-bg-alt);
            border-color: var(--dark-border);
            box-shadow: none;
        }

        body.night .night-toggle {
            background-color: var(--primary-hover);
            color: white;
        }

        body.night .tooltip {
            background-color: var(--dark-bg);
            color: var(--dark-text-color);
            border: 1px solid var(--dark-border);
            box-shadow: var(--shadow);
        }

        body.night .tooltip::after {
            border-top-color: var(--dark-border);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            line-height: 1.6;
            background-color: var(--bg-alt);
            padding-bottom: 3rem;
        }

        /* General Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Header and Title */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 2.2rem;
            color: var(--primary);
            font-weight: 800;
        }

        .night-toggle {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            background-color: var(--primary);
            color: white;
            transition: background-color 0.2s, transform 0.1s;
        }

        .night-toggle:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 0;
            border-bottom: 3px solid var(--border);
        }

        .tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            background-color: var(--bg-alt);
            border: 1px solid var(--border);
            border-bottom: none;
            margin-bottom: -1px;
            transition: background-color 0.2s, color 0.2s;
            max-width: 250px;
            text-align: center;
        }

        .tab:hover:not(.active) {
            background-color: #f1f5f9;
        }

        .tab.active {
            background-color: var(--bg);
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 0.8rem;
        }

        body.night .tab.active {
            background-color: var(--dark-bg-alt);
            color: var(--primary);
            border-color: var(--dark-border);
            border-bottom: 3px solid var(--primary);
        }

        /* Tab Content */
        .tab-content {
            background: var(--bg);
            padding: 2rem;
            border-bottom-left-radius: 18px;
            border-bottom-right-radius: 18px;
            border-top-right-radius: 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: none;
            margin-bottom: 1.5rem;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Styling */
        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-section {
            grid-column: 1 / -1;
            padding: 1rem;
            border-radius: 12px;
        }

        .form-section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            grid-column: 1 / -1;
        }
        
        body.night .form-section-title {
            border-bottom-color: var(--dark-border);
        }

        .deductions-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .deduction-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            align-items: flex-end;
            padding: 0.8rem;
            background: var(--bg-alt);
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        body.night .deduction-item {
            background: var(--dark-bg);
            border-color: var(--dark-border);
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
        }

        input[type="number"] {
            width: 100%;
            padding: 0.6rem 0.8rem;
            margin-top: 0.3rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="number"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }

        /* Buttons */
        .deductions-section button,
        .controls button,
        .deduction-item button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        #addDeductionBtn {
            background-color: #10b981; /* Green */
            color: white;
            padding: 0.8rem 1rem;
        }

        #addDeductionBtn:hover {
            background-color: #059669;
        }

        .remove-deduction-btn {
            background-color: var(--secondary);
            color: white;
            padding: 0.6rem 0.8rem;
        }

        .remove-deduction-btn:hover {
            background-color: #b91c1c;
        }

        .controls {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: flex-end;
        }

        .controls button {
            background-color: #64748b;
            color: white;
        }

        .controls button:hover {
            background-color: #475569;
        }

        /* Resume Card */
        .resume-card {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 18px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .resume-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .resume-item {
            text-align: center;
            border-radius: 12px;
            padding: 1rem;
            background: var(--bg-alt);
            border: 1px solid var(--border);
        }
        
        body.night .resume-item {
            background: var(--dark-bg);
            border-color: var(--dark-border);
        }

        .resume-item h3 {
            font-size: 1rem;
            color: var(--primary-hover);
            margin-bottom: 0.5rem;
        }

        .resume-item .value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-color);
        }

        body.night .resume-item .value {
             color: var(--dark-text-color);
        }

        .resume-item .subtitle {
            font-size: 0.9rem;
            color: #64748b;
        }

        /* Table Styling */
        #tableContainer {
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            background: var(--bg);
        }
        
        body.night table {
            background: var(--dark-bg-alt);
        }

        th, td {
            padding: 12px 15px;
            border: 1px solid var(--border);
        }
        
        body.night th, body.night td {
            border-color: var(--dark-border);
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        tr:nth-child(even) {
            background-color: var(--bg-alt);
        }
        
        body.night tr:nth-child(even) {
            background-color: var(--dark-bg);
        }
        
        /* Tooltip Styling */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .tooltip-icon {
            width: 16px;
            height: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: help;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 10;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(0);
            background-color: var(--bg);
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            font-size: 0.9rem;
            line-height: 1.4;
            max-width: 250px;
            text-align: center;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none; /* Crucial for hover to work correctly */
        }

        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--border) transparent transparent transparent;
        }
        
        body.night .tooltip::after {
            border-top-color: var(--dark-border);
        }

        .tooltip-icon:hover + .tooltip,
        .tooltip:hover {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px); /* Lift a little */
        }

        /* 2D Chart Container */
        #chartContainer {
            width: 100%;
            max-width: 1000px;
            height: 500px;
            margin: 1rem auto;
            background: var(--bg);
            border-radius: 18px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            padding: 1.2rem;
            position: relative;
        }

        body.night #chartContainer {
            background: var(--dark-bg-alt);
            border-color: var(--dark-border);
        }
        
        #savingChart {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .header {
                flex-direction: column;
                gap: 0.75rem;
                align-items: center;
                margin-bottom: 0.8rem;
            }
            
            h1 {
                text-align: center;
            }
            
            .tabs {
                flex-direction: column;
                align-items: stretch;
                gap: 0.4rem;
                border-bottom: none;
            }
            
            .tab {
                max-width: 100%;
                border-bottom: 1px solid var(--border);
                border-radius: 12px;
            }

            .tab.active {
                border-bottom: 1px solid var(--primary);
            }
            
            .tab-content {
                padding: 1.2rem;
            }
            
            form {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .resume-grid {
                grid-template-columns: 1fr;
            }
            
            .deduction-item {
                grid-template-columns: 1fr 1fr;
                gap: 0.6rem;
            }
            
            .deduction-item button {
                grid-column: 1 / -1;
            }

            .tooltip {
                max-width: 180px;
                left: 0;
                transform: translateX(0) translateY(-100%);
            }

            .tooltip::after {
                left: 20px;
                transform: translateX(0);
            }

            .tooltip-icon:hover + .tooltip,
            .tooltip:hover {
                transform: translateX(0) translateY(-100%) translateY(-5px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Calculadora de Ahorro</h1>
            <button id="toggleNightBtn" class="night-toggle">üåô Modo noche</button>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="basico">üìä B√°sico</div>
            <div class="tab" data-tab="avanzado">üéØ Avanzado</div>
        </div>

        <div id="basico" class="tab-content active">
            <form id="formBasico" onsubmit="return false;"></form>
        </div>

        <div id="avanzado" class="tab-content">
            <form id="formAvanzado" onsubmit="return false;">
                <div class="form-section">
                    <div class="form-section-title">Par√°metros Principales</div>
                </div>
                <div class="form-section deductions-section">
                    <div class="form-section-title">Deducciones por gastos</div>
                    <div class="deductions-container" id="deductionsContainer">
                        </div>
                    <button type="button" id="addDeductionBtn">‚ûï A√±adir gasto</button>
                </div>
            </form>
        </div>

        <div id="resumen" class="resume-card"></div>

        <div class="controls">
            <button id="toggleTableBtn">üëÅÔ∏è Ocultar tabla</button>
        </div>

        <div id="tableContainer"></div>
        
        <div id="chartContainer">
            <canvas id="savingChart"></canvas>
        </div>
    </div>

    <script>
        // --- SECCI√ìN DE CONFIGURACI√ìN ---
        const camposBasico = [
            ['Edad inicio', 'edadInicioBasico', 25],
            ['Edad fin', 'edadFinBasico', 65],
            ['Monto inicial', 'montoInicialBasico', 0],
            ['Aporte mensual', 'aporteMensualBasico', 100],
            ['Rendimiento anual estimado (%)', 'rendimientoBasico', 5],
            ['Inflaci√≥n anual estimada (%)', 'inflacionBasico', 3],
        ];

        const camposAvanzado = [
            ['Monto inicial', 'montoInicialAdv', 0, 'Dinero que ya tienes ahorrado para empezar'],
            ['Edad actual (Etapa 1)', 'edadInicioAdv', 25, 'Tu edad actual para comenzar la primera etapa de ahorro'],
            ['Aporte mensual etapa 1', 'aporteTramo1', 1200, 'Cu√°nto planeas ahorrar mensualmente en tus primeros a√±os (ej: 25-35 a√±os)'],
            ['Edad inicio etapa 2', 'edadCambio1Adv', 35, 'Edad en que cambiar√°s tu estrategia de ahorro (ej: cuando tengas mejor sueldo)'],
            ['Aporte mensual etapa 2', 'aporteTramo2', 1500, 'Nuevo monto mensual en la segunda etapa (ej: 35-50 a√±os)'],
            ['Edad etapa 3', 'edadCambio2Adv', 50, 'Edad para la tercera etapa (ej: cuando est√©s en tu mejor momento econ√≥mico)'],
            ['Aporte mensual etapa 3', 'aporteTramo3', 1800, 'Monto mensual en la etapa final antes del retiro (ej: 50-65 a√±os)'],
            ['Edad objetivo', 'edadFinAdv', 65, 'Edad en la que planeas jubilarte o necesitar el dinero'],
            ['Rendimiento anual (%)', 'rendimientoAdv', 5, 'Rentabilidad promedio anual esperada de tus inversiones'],
            ['Inflaci√≥n anual (%)', 'inflacionAdv', 3, 'Inflaci√≥n promedio anual esperada (reduce el poder adquisitivo)'],
        ];

        // --- SECCI√ìN DE UTILIDADES ---
        function formatearNumero(numero) {
            return Math.round(numero).toLocaleString();
        }

        // --- SECCI√ìN DE RENDERIZACI√ìN DE LA UI ---
        function generarInputs(campos, formId) {
            const form = document.getElementById(formId);
            const targetElement = formId === 'formAvanzado' ? form.querySelector('.form-section') : form;
            
            targetElement.innerHTML = formId === 'formAvanzado' ? '<div class="form-section-title">Par√°metros Principales</div>' : '';

            campos.forEach(([labelText, id, valor, tooltip]) => {
                // *** CORRECCI√ìN CR√çTICA DE COMPATIBILIDAD JS ***
                // Reemplazado '??' por el operador ternario para evitar SyntaxError en navegadores m√°s antiguos o estrictos.
                const storedValue = localStorage.getItem(id);
                const value = storedValue !== null ? storedValue : valor;
                // **********************************************
                
                const label = document.createElement('label');
                
                if (tooltip) {
                    label.innerHTML = `
                        <div class="tooltip-container">
                            ${labelText}
                            <div class="tooltip-icon">?</div>
                            <div class="tooltip">${tooltip}</div>
                        </div>
                        <input type="number" id="${id}" value="${value}">
                    `;
                } else {
                    label.innerHTML = `${labelText}<input type="number" id="${id}" value="${value}">`;
                }
                targetElement.appendChild(label);
            });
        }
        
        function addDeductionInput(edad = '', monto = '') {
            const container = document.getElementById('deductionsContainer');
            const div = document.createElement('div');
            div.className = 'deduction-item';
            div.innerHTML = `
                <label>
                    Edad del gasto
                    <input type="number" class="deduction-age" value="${edad}" placeholder="Ej: 40" min="0">
                </label>
                <label>
                    Monto anual
                    <input type="number" class="deduction-amount" value="${monto}" placeholder="Ej: 5000" min="0">
                </label>
                <button type="button" class="remove-deduction-btn">‚ûñ Eliminar</button>
            `;
            container.appendChild(div);
            
            div.querySelector('.remove-deduction-btn').addEventListener('click', () => {
                div.remove();
                autoCalcular();
            });
            
            div.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', autoCalcular);
            });
        }

        function renderChart2D(datos, inflacion, e0) {
            const ctx = document.getElementById('savingChart').getContext('2d');
            const years = datos.map(d => d.edad);
            const nominalData = datos.map(d => d.saldo);
            const realData = datos.map(d => d.saldoReal);
            
            if (window.myChart) {
                window.myChart.destroy();
            }
            
            const isDark = document.body.classList.contains('night');
            const gridColor = isDark ? 'rgba(148, 163, 184, 0.2)' : 'rgba(226, 232, 240, 0.8)';
            const textColor = isDark ? '#f1f5f9' : '#1e293b';

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Saldo Nominal',
                        data: nominalData,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                    }, {
                        label: 'Poder Adquisitivo Real',
                        data: realData,
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.2)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor,
                                font: { family: 'Inter, "Segoe UI", sans-serif', size: 14 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Proyecci√≥n de Ahorros por A√±o',
                            color: textColor,
                            font: { family: 'Inter, "Segoe UI", sans-serif', size: 20, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += `$${formatearNumero(context.parsed.y)}`; }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Edad',
                                color: textColor,
                                font: { family: 'Inter, "Segoe UI", sans-serif', size: 16, weight: 'bold' }
                            },
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Saldo (en $)',
                                color: textColor,
                                font: { family: 'Inter, "Segoe UI", sans-serif', size: 16, weight: 'bold' }
                            },
                            grid: { color: gridColor },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return `$${formatearNumero(value)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderResultados(datos, e0, inflacion, totalAportadoFinal) {
            const tabla = datos.map(d => {
                return `<tr><td>${d.edad}</td><td>$${formatearNumero(d.saldo)}</td><td>$${formatearNumero(d.saldoReal)}</td></tr>`;
            }).join('');
            
            document.getElementById('tableContainer').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Edad</th>
                            <th>Saldo Nominal</th>
                            <th>Saldo Real</th>
                        </tr>
                    </thead>
                    <tbody>${tabla}</tbody>
                </table>
            `;

            renderChart2D(datos, inflacion, e0);

            const final = datos[datos.length - 1];
            const realFinal = final.saldoReal;
            const generadoPorInversion = final.saldo - totalAportadoFinal;
            
            let edadAlMillon = 'No alcanzado';
            for (let i = 0; i < datos.length; i++) {
                if (datos[i].saldo >= 1000000) {
                    edadAlMillon = datos[i].edad;
                    break;
                }
            }

            document.getElementById('resumen').innerHTML = `
                <div class="resume-grid">
                    <div class="resume-item">
                        <h3>üéØ Monto Final</h3>
                        <div class="value">$${formatearNumero(final.saldo)}</div>
                        <div class="subtitle">A los ${final.edad} a√±os</div>
                    </div>
                    
                    <div class="resume-item">
                        <h3>üí™ Poder Adquisitivo</h3>
                        <div class="value">$${formatearNumero(realFinal)}</div>
                        <div class="subtitle">Equivalente hoy</div>
                    </div>
                    
                    <div class="resume-item">
                        <h3>üöÄ Edad al Mill√≥n</h3>
                        <div class="value">${edadAlMillon === 'No alcanzado' ? '‚ùå' : edadAlMillon}</div>
                        <div class="subtitle">${edadAlMillon === 'No alcanzado' ? 'No se alcanza' : 'a√±os'}</div>
                    </div>
                    
                    <div class="resume-item">
                        <h3>üìà Generado por Inversi√≥n</h3>
                        <div class="value">$${formatearNumero(generadoPorInversion)}</div>
                        <div class="subtitle">vs $${formatearNumero(totalAportadoFinal)} aportados</div>
                    </div>
                </div>
            `;
        }

        // --- SECCI√ìN DE C√ÅLCULOS ---
        function getDeductions() {
            const deductions = {};
            document.querySelectorAll('.deduction-item').forEach(item => {
                const age = parseInt(item.querySelector('.deduction-age').value);
                const amount = parseFloat(item.querySelector('.deduction-amount').value);
                if (!isNaN(age) && !isNaN(amount) && amount > 0) {
                    // Suma si ya existe un gasto en esa edad
                    deductions[age] = (deductions[age] || 0) + amount; 
                }
            });
            return deductions;
        }

        function calcularBasico() {
            const e0 = +document.getElementById('edadInicioBasico').value;
            const eF = +document.getElementById('edadFinBasico').value;
            const aporteMensual = +document.getElementById('aporteMensualBasico').value;
            const rendimiento = +document.getElementById('rendimientoBasico').value / 100;
            const inflacion = +document.getElementById('inflacionBasico').value / 100;
            let saldo = +document.getElementById('montoInicialBasico').value;
            
            if (!e0 || !eF || eF < e0) return;
            
            const datos = [];
            let totalAportado = +document.getElementById('montoInicialBasico').value;
            
            // Loop para cada a√±o
            for (let edad = e0; edad <= eF; edad++) {
                // El primer punto es el saldo inicial (a la edad e0)
                if (edad === e0) {
                     // El saldo inicial debe guardarse como el primer punto de datos
                     const realInicial = saldo / Math.pow(1 + inflacion, edad - e0);
                     datos.push({ edad, saldo, saldoReal: realInicial, totalAportado });
                     continue; // Pasa al siguiente a√±o para empezar a sumar aportes y rendimiento
                }
                
                // En a√±os posteriores, el c√°lculo es:
                
                // 1. Sumar aporte anual (mensual * 12)
                const aporteAnual = aporteMensual * 12;
                saldo += aporteAnual;
                totalAportado += aporteAnual;
                
                // 2. Aplicar el rendimiento anual al saldo
                saldo *= (1 + rendimiento);
                
                // 3. Aplicar la inflaci√≥n para el c√°lculo del saldo real (poder adquisitivo)
                const real = saldo / Math.pow(1 + inflacion, edad - e0);
                datos.push({ edad, saldo, saldoReal: real, totalAportado });
            }
            
            renderResultados(datos, e0, inflacion, totalAportado);
        }

        function calcularAvanzado() {
            const e0 = +document.getElementById('edadInicioAdv').value;
            const e1 = +document.getElementById('edadCambio1Adv').value;
            const e2 = +document.getElementById('edadCambio2Adv').value;
            const eF = +document.getElementById('edadFinAdv').value;
            const a1 = +document.getElementById('aporteTramo1').value * 12; // Aporte anual
            const a2 = +document.getElementById('aporteTramo2').value * 12; // Aporte anual
            const a3 = +document.getElementById('aporteTramo3').value * 12; // Aporte anual
            const rendimiento = +document.getElementById('rendimientoAdv').value / 100;
            const inflacion = +document.getElementById('inflacionAdv').value / 100;
            let saldo = +document.getElementById('montoInicialAdv').value;

            const deducciones = getDeductions();
            
            if (!e0 || !eF || eF < e0) return;
            
            const datos = [];
            let totalAportado = +document.getElementById('montoInicialAdv').value; // Solo el monto inicial
            
            for (let edad = e0; edad <= eF; edad++) {
                
                // El primer punto es el saldo inicial (a la edad e0)
                if (edad === e0) {
                     // El saldo inicial debe guardarse como el primer punto de datos
                     const realInicial = saldo / Math.pow(1 + inflacion, edad - e0);
                     datos.push({ edad, saldo, saldoReal: realInicial, totalAportado });
                     continue; // Pasa al siguiente a√±o para empezar a sumar aportes y rendimiento
                }
                
                let aporteAnual = 0;
                
                // Determinar el aporte anual seg√∫n la edad
                if (edad < e1) {
                    aporteAnual = a1;
                } else if (edad < e2) {
                    aporteAnual = a2;
                } else {
                    aporteAnual = a3;
                }
                
                // 1. Sumar aporte
                saldo += aporteAnual;
                totalAportado += aporteAnual;
                
                // 2. Aplicar deducciones (gastos grandes puntuales)
                if (deducciones[edad]) {
                    saldo -= deducciones[edad];
                    // Nota: No se suma a totalAportado (que es el dinero INGRESADO). 
                    // Se resta del saldo final. La m√©trica 'Generado por Inversi√≥n' es m√°s precisa as√≠.
                }
                
                // 3. Calcular nuevo saldo con rendimiento
                saldo *= (1 + rendimiento);
                
                // 4. Aplicar la inflaci√≥n para el c√°lculo del saldo real
                const real = saldo / Math.pow(1 + inflacion, edad - e0);
                datos.push({ edad, saldo, saldoReal: real, totalAportado });
            }
            
            renderResultados(datos, e0, inflacion, totalAportado);
        }

        function autoCalcular() {
            // Guardar todos los valores de los inputs en localStorage antes de calcular
            document.querySelectorAll('input[type="number"]').forEach(input => {
                localStorage.setItem(input.id, input.value);
            });
            
            // Guardar las deducciones para que persistan
            const deductionsArray = [];
            document.querySelectorAll('.deduction-item').forEach(item => {
                const age = item.querySelector('.deduction-age').value;
                const amount = item.querySelector('.deduction-amount').value;
                if (age && amount) {
                    deductionsArray.push({ age, amount });
                }
            });
            localStorage.setItem('deductionsAdv', JSON.stringify(deductionsArray));

            // Calcular
            const tab = document.querySelector('.tab.active').dataset.tab;
            if (tab === 'basico') {
                calcularBasico();
            } else {
                calcularAvanzado();
            }
        }
        
        function cambiarPestana(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            autoCalcular();
        }

        // --- SECCI√ìN DE EVENT LISTENERS ---
        document.getElementById('toggleTableBtn').addEventListener('click', () => {
            const cont = document.getElementById('tableContainer');
            const visible = cont.style.display !== 'none';
            cont.style.display = visible ? 'none' : 'block';
            document.getElementById('toggleTableBtn').textContent = visible ? 'üëÅÔ∏è Mostrar tabla' : 'üëÅÔ∏è Ocultar tabla';
        });

        document.getElementById('toggleNightBtn').addEventListener('click', () => {
            document.body.classList.toggle('night');
            const isDark = document.body.classList.contains('night');
            document.getElementById('toggleNightBtn').textContent = isDark ? '‚òÄÔ∏è Modo d√≠a' : 'üåô Modo noche';
            
            // Re-renderizar el gr√°fico para actualizar los colores
            if (window.myChart) {
                const currentTab = document.querySelector('.tab.active').dataset.tab;
                if (currentTab === 'basico') {
                    calcularBasico();
                } else {
                    calcularAvanzado();
                }
            }
        });
        
        document.getElementById('addDeductionBtn').addEventListener('click', () => {
            addDeductionInput();
            autoCalcular();
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                cambiarPestana(tab.dataset.tab);
            });
        });

        // --- SECCI√ìN DE INICIALIZACI√ìN ---
        function init() {
            generarInputs(camposBasico, 'formBasico');
            generarInputs(camposAvanzado, 'formAvanzado');
            
            // Cargar deducciones guardadas
            const storedDeductions = localStorage.getItem('deductionsAdv');
            const deductionsContainer = document.getElementById('deductionsContainer');
            deductionsContainer.innerHTML = ''; // Limpiar las por defecto

            if (storedDeductions) {
                JSON.parse(storedDeductions).forEach(d => {
                    addDeductionInput(d.age, d.amount);
                });
            } else {
                // Valores por defecto
                addDeductionInput(30, 20000);
                addDeductionInput(45, 50000);
            }

            // Asignar el listener de autoCalcular a todos los inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', autoCalcular);
            });
            
            // Asignar listeners a inputs de deducciones por si se cargaron desde localStorage
            document.querySelectorAll('.deduction-item input').forEach(input => {
                input.addEventListener('input', autoCalcular);
            });

            // Reasignar listeners a botones de eliminar de deducciones (por si se cargaron desde localStorage)
            document.querySelectorAll('.remove-deduction-btn').forEach(button => {
                 button.addEventListener('click', (event) => {
                    event.target.closest('.deduction-item').remove();
                    autoCalcular();
                });
            });
            
            // Inicializar el modo noche si estaba activo
            if (localStorage.getItem('nightMode') === 'true') {
                 document.body.classList.add('night');
                 document.getElementById('toggleNightBtn').textContent = '‚òÄÔ∏è Modo d√≠a';
            }
            document.getElementById('toggleNightBtn').addEventListener('click', () => {
                const isDark = document.body.classList.toggle('night');
                localStorage.setItem('nightMode', isDark);
            });

            autoCalcular();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
