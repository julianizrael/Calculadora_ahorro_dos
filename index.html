<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Ahorro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --color-primario: #0077cc;
      --color-fondo: #f4f8fc;
      --color-fondo-noche: #121824;
      --color-texto: #222;
      --color-texto-noche: #ddd;
      --color-boton: #005fa3;
      --color-boton-hover: #004880;
      --color-tab-activo: #005fa3;
      --color-tab-inactivo: #aaccee;
      --color-borde: #ccc;
      --color-borde-noche: #444;
    }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--color-fondo);
      color: var(--color-texto);
      transition: background-color 0.3s, color 0.3s;
    }
    body.night {
      background: var(--color-fondo-noche);
      color: var(--color-texto-noche);
    }

    h1 {
      color: var(--color-primario);
      margin-bottom: 1rem;
      text-align: center;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
      user-select: none;
    }
    .tab {
      padding: 0.5rem 1.5rem;
      margin: 0 0.3rem;
      background: var(--color-tab-inactivo);
      color: #004080;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
      box-shadow: inset 0 -3px 0 #004080;
      transition: background-color 0.3s, color 0.3s;
    }
    .tab.active {
      background: var(--color-tab-activo);
      color: white;
      box-shadow: none;
    }
    .tab:hover:not(.active) {
      background: #a2c5f7;
    }
    .tab-content {
      display: none;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      max-width: 900px;
      margin: 0 auto 2rem auto;
      transition: background-color 0.3s, color 0.3s;
    }
    body.night .tab-content {
      background: #1e2a44;
      color: var(--color-texto-noche);
      box-shadow: 0 0 12px rgba(0,0,0,0.6);
    }
    .tab-content.active {
      display: block;
    }
    form {
      max-width: 900px;
      margin: 0 auto;
    }
    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
      gap: 1rem 1.5rem;
      margin-bottom: 1rem;
    }
    label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      font-size: 0.9rem;
      user-select: none;
    }
    input[type=number] {
      margin-top: 0.3rem;
      padding: 0.5rem 0.7rem;
      font-size: 1rem;
      border: 2px solid var(--color-borde);
      border-radius: 6px;
      transition: border-color 0.25s;
      background: #fff;
      color: #222;
    }
    body.night input[type=number] {
      background: #2a3b5b;
      color: var(--color-texto-noche);
      border-color: var(--color-borde-noche);
    }
    input[type=number]:focus {
      border-color: var(--color-primario);
      outline: none;
    }
    button {
      cursor: pointer;
      background: var(--color-boton);
      border: none;
      color: white;
      font-weight: 700;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: background-color 0.3s;
      user-select: none;
    }
    button:hover {
      background: var(--color-boton-hover);
    }
    #listaHitos {
      max-width: 900px;
      margin: 0 auto 1.5rem auto;
      color: #333;
    }
    body.night #listaHitos {
      color: #ccc;
    }
    .hitos-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #d9e8ff;
      border-radius: 6px;
      padding: 0.3rem 0.7rem;
      margin-bottom: 0.3rem;
      font-weight: 600;
      font-size: 0.9rem;
      user-select: none;
      color: #003366;
    }
    body.night .hitos-list-item {
      background: #344c7a;
      color: #a9c1ff;
    }
    .hitos-list-item button {
      background: transparent;
      border: none;
      color: #900;
      font-weight: 700;
      font-size: 1.1rem;
      line-height: 1;
      padding: 0;
      cursor: pointer;
      user-select: none;
      transition: color 0.3s;
    }
    .hitos-list-item button:hover {
      color: #f33;
    }

    #toggleTableBtn, #toggleNightBtn {
      display: block;
      max-width: 900px;
      margin: 0 auto 1rem auto;
      width: 140px;
      text-align: center;
      user-select: none;
    }
    #toggleTableBtn {
      background: var(--color-primario);
      color: white;
      border-radius: 6px;
    }
    #toggleTableBtn:hover {
      background: #005499;
    }
    #toggleNightBtn {
      background: #444;
      color: white;
      border-radius: 6px;
      margin-top: 0;
      margin-bottom: 2rem;
    }
    #toggleNightBtn:hover {
      background: #222;
    }
    #tableContainer {
      max-width: 900px;
      margin: 0 auto 2rem auto;
      overflow-x: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 8px;
      background: white;
      transition: background-color 0.3s, color 0.3s;
    }
    body.night #tableContainer {
      background: #1a2640;
      box-shadow: 0 2px 10px rgba(0,0,0,0.7);
      color: var(--color-texto-noche);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.9rem;
      color: inherit;
    }
    th, td {
      border: 1px solid var(--color-borde);
      padding: 0.5rem 0.7rem;
      text-align: center;
      user-select: text;
    }
    body.night th, body.night td {
      border-color: #445877;
    }

    canvas {
      max-width: 900px;
      margin: 0 auto 2rem auto;
      display: block;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      transition: background-color 0.3s;
    }
    body.night canvas {
      background: #1a2640;
      box-shadow: 0 0 18px rgba(0,0,0,0.7);
    }
  </style>
</head>
<body>
  <h1>Calculadora de Ahorro</h1>

  <button id="toggleNightBtn" title="Modo noche">Modo noche 游깿</button>

  <div class="tabs">
    <div class="tab active" data-tab="basico">B치sico</div>
    <div class="tab" data-tab="avanzado">Avanzado</div>
  </div>

  <div id="basico" class="tab-content active">
    <form id="formBasico" autocomplete="off" onsubmit="return false;">
      <div class="input-group">
        <label>Edad inicio
          <input type="number" id="edadInicioBasico" min="0" max="120" value="25" />
        </label>
        <label>Edad fin
          <input type="number" id="edadFinBasico" min="0" max="120" value="65" />
        </label>
        <label>Monto inicial
          <input type="number" id="montoInicialBasico" value="0" min="0" />
        </label>
        <label>Aporte mensual
          <input type="number" id="aporteMensualBasico" value="10000" min="0" />
        </label>
        <label>Rendimiento anual (%)
          <input type="number" id="rendimientoBasico" value="10" min="0" step="0.01" />
        </label>
        <label>Inflaci칩n anual (%)
          <input type="number" id="inflacionBasico" value="5" min="0" step="0.01" />
        </label>
      </div>
    </form>
  </div>

  <div id="avanzado" class="tab-content">
    <form id="formAvanzado" autocomplete="off" onsubmit="return false;">
      <div class="input-group">
        <label>Edad inicio
          <input type="number" id="edadInicioAdv" min="0" max="120" value="25" />
        </label>
        <label>Edad cambio 1
          <input type="number" id="edadCambio1Adv" min="0" max="120" value="35" />
        </label>
        <label>Edad cambio 2
          <input type="number" id="edadCambio2Adv" min="0" max="120" value="50" />
        </label>
        <label>Edad fin
          <input type="number" id="edadFinAdv" min="0" max="120" value="65" />
        </label>
      </div>

      <div class="input-group">
        <label>Aporte tramo 1 (mensual)
          <input type="number" id="aporteTramo1" value="10000" min="0" />
        </label>
        <label>Aporte tramo 2 (mensual)
          <input type="number" id="aporteTramo2" value="15000" min="0" />
        </label>
        <label>Aporte tramo 3 (mensual)
          <input type="number" id="aporteTramo3" value="20000" min="0" />
        </label>
        <label>Monto inicial
          <input type="number" id="montoInicialAdv" value="0" min="0" />
        </label>
        <label>Rendimiento anual (%)
          <input type="number" id="rendimientoAdv" value="10" min="0" step="0.01" />
        </label>
        <label>Inflaci칩n anual (%)
          <input type="number" id="inflacionAdv" value="5" min="0" step="0.01" />
        </label>
      </div>

      <div class="input-group" style="align-items:center;">
        <label>Edad hito
          <input type="number" id="edadHito" min="0" max="120" />
        </label>
        <label>Gasto hito
          <input type="number" id="gastoHito" min="0" />
        </label>
        <button type="button" id="addHitoBtn" style="height:2.3rem;">Agregar hito</button>
      </div>

      <div id="listaHitos"></div>
    </form>
  </div>

  <button id="toggleTableBtn">Ocultar tabla</button>
  <div id="tableContainer"></div>

  <canvas id="chartBalance"></canvas>

<script>
  // Variables globales
  let hitos = [];
  let tablaVisible = true;
  let chartInstance = null;

  // Funci칩n para calcular mes a mes para mejor precisi칩n
  function calcularBasico() {
    const e0 = Number(document.getElementById('edadInicioBasico').value);
    const eF = Number(document.getElementById('edadFinBasico').value);
    const aporteMensual = Number(document.getElementById('aporteMensualBasico').value);
    const rendimientoAnual = Number(document.getElementById('rendimientoBasico').value) / 100;
    const inflacionAnual = Number(document.getElementById('inflacionBasico').value) / 100;
    const montoInicial = Number(document.getElementById('montoInicialBasico').value);

    if (e0 >= eF || aporteMensual < 0 || rendimientoAnual < 0 || inflacionAnual < 0) {
      mostrarMensajeError('Por favor, revisa los valores ingresados en B치sico.');
      return;
    }

    const mesesTotales = (eF - e0) * 12;
    let saldo = montoInicial;
    const resultados = [];

    for (let mes = 0; mes <= mesesTotales; mes++) {
      // Solo aportes mensuales (antes de intereses)
      if(mes > 0) saldo += aporteMensual;

      // Inter칠s mensual compuesto
      saldo *= Math.pow(1 + rendimientoAnual, 1/12);

      // Cuando es final de a침o (mes % 12 === 0), guardamos resultado
      if(mes % 12 === 0) {
        const edad = e0 + (mes / 12);
        resultados.push({ edad, saldo });
      }
    }

    renderResultados(resultados, e0, inflacionAnual);
  }

  function calcularAvanzado() {
    const e0 = Number(document.getElementById('edadInicioAdv').value);
    const e1 = Number(document.getElementById('edadCambio1Adv').value);
    const e2 = Number(document.getElementById('edadCambio2Adv').value);
    const eF = Number(document.getElementById('edadFinAdv').value);

    const aporte1 = Number(document.getElementById('aporteTramo1').value);
    const aporte2 = Number(document.getElementById('aporteTramo2').value);
    const aporte3 = Number(document.getElementById('aporteTramo3').value);

    const rendimientoAnual = Number(document.getElementById('rendimientoAdv').value) / 100;
    const inflacionAnual = Number(document.getElementById('inflacionAdv').value) / 100;
    const montoInicial = Number(document.getElementById('montoInicialAdv').value);

    if (e0 >= eF || aporte1 < 0 || aporte2 < 0 || aporte3 < 0 || rendimientoAnual < 0 || inflacionAnual < 0) {
      mostrarMensajeError('Por favor, revisa los valores ingresados en Avanzado.');
      return;
    }

    const mesesTotales = (eF - e0) * 12;
    let saldo = montoInicial;
    const resultados = [];

    for (let mes = 0; mes <= mesesTotales; mes++) {
      const edadActual = e0 + (mes / 12);

      // Defino aporte mensual segun tramo
      let aporte;
      if (edadActual < e1) aporte = aporte1;
      else if (edadActual < e2) aporte = aporte2;
      else aporte = aporte3;

      // Sumo aporte
      if(mes > 0) saldo += aporte;

      // Resto gastos hito que ocurran en esta edad (solo al cumplir a침o)
      if (mes % 12 === 0) {
        const edadEntera = Math.round(edadActual);
        const gastosHitos = hitos.filter(h => h.edad === edadEntera).reduce((acc, h) => acc + h.gasto, 0);
        saldo -= gastosHitos;
      }

      // Aplico inter칠s mensual compuesto
      saldo *= Math.pow(1 + rendimientoAnual, 1/12);

      // Al final de cada a침o, guardo el resultado
      if(mes % 12 === 0) {
        resultados.push({ edad: e0 + (mes / 12), saldo });
      }
    }

    renderResultados(resultados, e0, inflacionAnual);
  }

  // Funci칩n para mostrar mensaje de error simple (puede mejorarse)
  function mostrarMensajeError(msg) {
    alert(msg);
  }

  // Funci칩n para mostrar la tabla y gr치ficos
  function renderResultados(data, edadInicio, inflacion) {
    // Tabla con saldo nominal y saldo real ajustado por inflaci칩n
    const filas = data.map(({edad, saldo}) => {
      const saldoReal = saldo / Math.pow(1 + inflacion, edad - edadInicio);
      return `
        <tr>
          <td>${edad.toFixed(1)}</td>
          <td>${saldo.toFixed(2)}</td>
          <td>${saldoReal.toFixed(2)}</td>
        </tr>`;
    }).join("");

    document.getElementById('tableContainer').innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Edad</th>
            <th>Saldo Nominal</th>
            <th>Saldo Real (ajustado inflaci칩n)</th>
          </tr>
        </thead>
        <tbody>${filas}</tbody>
      </table>`;

    const labels = data.map(d => d.edad.toFixed(1));
    const saldoNominal = data.map(d => d.saldo);
    const saldoReal = data.map(d => d.saldo / Math.pow(1 + inflacion, d.edad - edadInicio));

    // Si ya hay un gr치fico, destruirlo para refrescar
    if(chartInstance) chartInstance.destroy();

    const ctx = document.getElementById('chartBalance').getContext('2d');
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Saldo Nominal',
            data: saldoNominal,
            borderColor: '#0077cc',
            backgroundColor: 'rgba(0,119,204,0.2)',
            fill: true,
            tension: 0.2,
            pointRadius: 3,
            pointHoverRadius: 6,
          },
          {
            label: 'Saldo Real',
            data: saldoReal,
            borderColor: '#00aa44',
            backgroundColor: 'rgba(0,170,68,0.2)',
            fill: true,
            tension: 0.2,
            pointRadius: 3,
            pointHoverRadius: 6,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'nearest',
          intersect: false
        },
        plugins: {
          legend: {
            labels: { color: getComputedStyle(document.body).color }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: context => context.dataset.label + ': $' + Number(context.parsed.y).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Edad', color: getComputedStyle(document.body).color },
            ticks: { color: getComputedStyle(document.body).color }
          },
          y: {
            title: { display: true, text: 'Saldo', color: getComputedStyle(document.body).color },
            ticks: { color: getComputedStyle(document.body).color },
            beginAtZero: true
          }
        }
      }
    });
  }

  // Auto-calcular al modificar inputs
  function autoCalcular() {
    if(document.getElementById('basico').classList.contains('active')) {
      calcularBasico();
    } else {
      calcularAvanzado();
    }
  }

  // Eventos: inputs
  document.querySelectorAll('input').forEach(input => {
    input.addEventListener('input', autoCalcular);
  });

  // Eventos: pesta침as
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
      autoCalcular();
    });
  });

  // Eventos: agregar hitos
  document.getElementById('addHitoBtn').addEventListener('click', () => {
    const edad = Number(document.getElementById('edadHito').value);
    const gasto = Number(document.getElementById('gastoHito').value);
    if(!Number.isInteger(edad) || edad < 0) {
      alert("Ingrese una edad v치lida para el hito (entero no negativo).");
      return;
    }
    if(isNaN(gasto) || gasto < 0) {
      alert("Ingrese un gasto v치lido para el hito (n칰mero no negativo).");
      return;
    }
    hitos.push({ edad, gasto });
    hitos.sort((a,b) => a.edad - b.edad);
    renderHitos();
    autoCalcular();
    // Limpio inputs hito
    document.getElementById('edadHito').value = '';
    document.getElementById('gastoHito').value = '';
  });

  function renderHitos() {
    const lista = document.getElementById('listaHitos');
    lista.innerHTML = '';
    if(hitos.length === 0) return;
    hitos.forEach((h, i) => {
      const div = document.createElement('div');
      div.className = 'hitos-list-item';
      div.innerHTML = `Edad: ${h.edad} - Gasto: $${h.gasto.toLocaleString()} <button aria-label="Eliminar hito" onclick="eliminarHito(${i})">칑</button>`;
      lista.appendChild(div);
    });
  }
  window.eliminarHito = function(i) {
    hitos.splice(i,1);
    renderHitos();
    autoCalcular();
  }

  // Toggle mostrar/ocultar tabla
  document.getElementById('toggleTableBtn').addEventListener('click', () => {
    tablaVisible = !tablaVisible;
    document.getElementById('tableContainer').style.display = tablaVisible ? 'block' : 'none';
    document.getElementById('toggleTableBtn').textContent = tablaVisible ? 'Ocultar tabla' : 'Mostrar tabla';
  });

  // Modo noche toggle
  document.getElementById('toggleNightBtn').addEventListener('click', () => {
    document.body.classList.toggle('night');
    // Refrescar gr치fico para colores acorde al modo
    autoCalcular();
  });

  // C치lculo inicial al cargar
  window.addEventListener('load', () => {
    autoCalcular();
  });
</script>

</body>
</html>
