<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Ahorro e Inversión</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Variables y Reset Básico */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #dc2626;
            --success: #10b981;
            --success-hover: #059669;
            --bg: #ffffff;
            --text-color: #1e293b;
            --bg-alt: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 4, 0, 0.1);

            /* Dark Mode Variables */
            --dark-bg: #0f172a;
            --dark-bg-alt: #1e293b;
            --dark-text-color: #f1f5f9;
            --dark-border: #334155;
            
            /* Colores Adicionales para Gráfico/Resultados */
            --aportado-color: #f59e0b; /* Amarillo/Ámbar */
        }

        /* Dark Mode */
        body.night {
            background-color: var(--dark-bg);
            color: var(--dark-text-color);
        }

        body.night .header h1,
        body.night .tab,
        body.night .tab-content,
        body.night .resume-card,
        body.night .controls button,
        body.night table {
            color: var(--dark-text-color);
        }

        body.night input[type="number"] {
            background: var(--dark-bg);
            border-color: var(--dark-border);
            color: var(--dark-text-color);
        }

        body.night .tab:not(.active) {
            background-color: var(--dark-bg-alt);
        }

        body.night .tab-content,
        body.night .resume-card,
        body.night #chartContainer {
            background-color: var(--dark-bg-alt);
            border-color: var(--dark-border);
            box-shadow: none;
        }

        body.night .night-toggle {
            background-color: var(--primary-hover);
            color: white;
        }

        body.night .tooltip {
            background-color: var(--dark-bg);
            color: var(--dark-text-color);
            border: 1px solid var(--dark-border);
            box-shadow: var(--shadow);
        }

        body.night .tooltip::after {
            border-top-color: var(--dark-border);
        }
        
        body.night .form-section-title {
            border-bottom-color: var(--dark-border);
        }

        body.night .deduction-item {
            background: var(--dark-bg);
            border-color: var(--dark-border);
        }
        
        body.night .resume-item {
            background: var(--dark-bg);
            border-color: var(--dark-border);
        }

        body.night table {
            background: var(--dark-bg-alt);
        }
        
        body.night th, body.night td {
            border-color: var(--dark-border);
        }

        body.night tr:nth-child(even) {
            background-color: var(--dark-bg);
        }
        
        body.night .tab.active {
            background-color: var(--dark-bg-alt);
            color: var(--primary);
            border-color: var(--dark-border);
            border-bottom: 3px solid var(--primary);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            line-height: 1.6;
            background-color: var(--bg-alt);
            /* AJUSTE: MÁRGENES */
            padding-bottom: 1.5rem; 
            transition: background-color 0.3s;
        }

        /* General Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Header and Title */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* AJUSTE: MÁRGENES */
            margin: 1rem 0 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 2.2rem;
            color: var(--primary);
            font-weight: 800;
        }

        .night-toggle {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            background-color: var(--primary);
            color: white;
            transition: background-color 0.2s, transform 0.1s;
        }

        .night-toggle:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 0;
            border-bottom: 3px solid var(--border);
        }

        .tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            background-color: var(--bg-alt);
            border: 1px solid var(--border);
            border-bottom: none;
            margin-bottom: -1px;
            transition: background-color 0.2s, color 0.2s;
            max-width: 250px;
            text-align: center;
        }

        .tab:hover:not(.active) {
            background-color: #f1f5f9;
        }

        .tab.active {
            background-color: var(--bg);
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 0.8rem;
        }

        /* Tab Content */
        .tab-content {
            background: var(--bg);
            /* AJUSTE: MÁRGENES */
            padding: 1.25rem; 
            border-bottom-left-radius: 18px;
            border-bottom-right-radius: 18px;
            border-top-right-radius: 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: none;
            /* AJUSTE: MÁRGENES */
            margin-bottom: 1rem; 
        }

        .tab-content.active {
            display: block;
        }

        /* Form Styling */
        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-section {
            grid-column: 1 / -1;
            padding: 0; 
            border-radius: 12px;
            display: grid;
            grid-template-columns: subgrid;
            gap: 1.5rem;
        }

        .form-section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            /* AJUSTE: MÁRGENES */
            margin-bottom: 0.75rem; 
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
            grid-column: 1 / -1;
        }
        
        .deductions-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
            grid-column: 1 / -1;
        }

        .deduction-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            align-items: flex-end;
            padding: 0.8rem;
            background: var(--bg-alt);
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .form-input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
            position: relative; /* Para el icono de error */
        }
        
        body.night label {
            color: var(--dark-text-color);
        }

        input[type="number"] {
            width: 100%;
            padding: 0.6rem 0.8rem;
            margin-top: 0.3rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="number"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }
        
        /* ESTILO PARA VALIDACIÓN DE ERROR (MEJORA 6) */
        input[data-error="true"] {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
        }

        .error-message {
            color: var(--secondary);
            font-size: 0.85rem;
            margin-top: 0.2rem;
            font-weight: 500;
            display: none;
        }

        input[data-error="true"] + .error-message {
            display: block;
        }
        /* FIN ESTILO PARA VALIDACIÓN DE ERROR */

        /* Buttons */
        .deductions-section button,
        .controls button,
        .deduction-item button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        #addDeductionBtn {
            background-color: var(--success);
            color: white;
            padding: 0.8rem 1rem;
            grid-column: 1 / -1;
            width: fit-content;
        }

        #addDeductionBtn:hover {
            background-color: var(--success-hover);
        }

        .remove-deduction-btn {
            background-color: var(--secondary);
            color: white;
            padding: 0.6rem 0.8rem;
            align-self: center;
        }

        .remove-deduction-btn:hover {
            background-color: #b91c1c;
        }

        .controls {
            /* AJUSTE: MÁRGENES */
            margin-bottom: 1rem; 
            display: flex;
            justify-content: flex-end;
        }

        .controls button {
            background-color: #64748b;
            color: white;
        }

        .controls button:hover {
            background-color: #475569;
        }

        /* Resume Card */
        .resume-card {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 18px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            /* AJUSTE: MÁRGENES */
            margin-bottom: 1rem; 
        }

        .resume-grid {
            /* Aumentar la cuadrícula para las 5 métricas */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            display: grid;
            gap: 1.5rem;
        }
        
        /* Estilo para la métrica de Retiro Mensual */
        .resume-item[data-highlight="true"] .value {
            color: var(--success);
        }

        .resume-item {
            text-align: center;
            border-radius: 12px;
            padding: 1rem;
            background: var(--bg-alt);
            border: 1px solid var(--border);
        }
        
        .resume-item h3 {
            font-size: 0.95rem; /* Ligeramente más pequeño para las 5 métricas */
            color: var(--primary-hover);
            margin-bottom: 0.5rem;
        }

        .resume-item .value {
            font-size: 2.2rem; /* Ligeramente más pequeño */
            font-weight: 800;
            color: var(--text-color);
            transition: color 0.3s;
        }

        body.night .resume-item .value {
             color: var(--dark-text-color);
        }
        
        body.night .resume-item[data-highlight="true"] .value {
            color: var(--success);
        }


        .resume-item .subtitle {
            font-size: 0.9rem;
            color: #64748b;
        }

        /* Table Styling */
        #tableContainer {
            /* AJUSTE: MÁRGENES */
            margin-bottom: 1rem; 
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            background: var(--bg);
        }

        th, td {
            padding: 12px 15px;
            border: 1px solid var(--border);
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        tr:nth-child(even) {
            background-color: var(--bg-alt);
        }
        
        /* Tooltip Styling */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            cursor: help;
        }

        .tooltip-icon {
            width: 16px;
            height: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 10;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(0);
            background-color: var(--bg);
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            font-size: 0.9rem;
            line-height: 1.4;
            max-width: 250px;
            text-align: center;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }

        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--border) transparent transparent transparent;
        }
        
        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        /* 2D Chart Container */
        #chartContainer {
            width: 100%;
            max-width: 1000px;
            height: 500px;
            /* AJUSTE: MÁRGENES */
            margin: 0.75rem auto; 
            background: var(--bg);
            border-radius: 18px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            padding: 1.2rem;
            position: relative;
        }
        
        #savingChart {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .header {
                flex-direction: column;
                gap: 0.75rem;
                align-items: center;
                margin-bottom: 0.8rem;
            }
            
            h1 {
                text-align: center;
            }
            
            .tabs {
                flex-direction: column;
                align-items: stretch;
                gap: 0.4rem;
                border-bottom: none;
            }
            
            .tab {
                max-width: 100%;
                border-bottom: 1px solid var(--border);
                border-radius: 12px;
            }

            .tab.active {
                border-bottom: 1px solid var(--primary);
            }
            
            .tab-content {
                padding: 1.2rem;
            }
            
            form {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .form-section {
                gap: 0.8rem;
            }
            
            .resume-grid {
                grid-template-columns: 1fr;
            }
            
            .deduction-item {
                grid-template-columns: 1fr 1fr;
                gap: 0.6rem;
            }
            
            .remove-deduction-btn {
                grid-column: 1 / -1;
            }

            .tooltip {
                max-width: 180px;
                left: 0;
                transform: translateX(0) translateY(-100%);
            }

            .tooltip::after {
                left: 20px;
                transform: translateX(0);
            }

            .tooltip-container:hover .tooltip {
                transform: translateX(0) translateY(-100%) translateY(-5px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💰 Calculadora de Ahorro</h1>
            <button id="toggleNightBtn" class="night-toggle">🌙 Modo noche</button>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="basico">📊 Básico</div>
            <div class="tab" data-tab="avanzado">🎯 Avanzado</div>
        </div>

        <div id="basico" class="tab-content active">
            <form id="formBasico" onsubmit="return false;"></form>
        </div>

        <div id="avanzado" class="tab-content">
            <form id="formAvanzado" onsubmit="return false;">
                <div class="form-section">
                    <div class="form-section-title">Parámetros Principales</div>
                </div>
                <div class="form-section deductions-section">
                    <div class="form-section-title">Deducciones por gastos</div>
                    <div class="deductions-container" id="deductionsContainer">
                        </div>
                    <button type="button" id="addDeductionBtn">➕ Añadir gasto</button>
                </div>
            </form>
        </div>

        <div id="resumen" class="resume-card"></div>

        <div class="controls">
            <button id="toggleTableBtn">👁️ Ocultar tabla</button>
        </div>

        <div id="tableContainer"></div>
        
        <div id="chartContainer">
            <canvas id="savingChart"></canvas>
        </div>
    </div>

    <script>
        // --- SECCIÓN DE CONFIGURACIÓN ---
        const camposBasico = [
            ['Edad inicio', 'edadInicioBasico', 25, 'Tu edad actual'],
            ['Edad fin', 'edadFinBasico', 65, 'La edad en la que deseas alcanzar tu objetivo'],
            ['Monto inicial', 'montoInicialBasico', 0],
            ['Aporte mensual', 'aporteMensualBasico', 100],
            ['Rendimiento anual estimado (%)', 'rendimientoBasico', 5, 'Rentabilidad promedio anual esperada de tus inversiones'],
            ['Inflación anual estimada (%)', 'inflacionBasico', 3, 'Inflación promedio anual esperada (reduce el poder adquisitivo)'],
        ];

        const camposAvanzado = [
            ['Monto inicial', 'montoInicialAdv', 0, 'Dinero que ya tienes ahorrado para empezar'],
            ['Edad actual (Etapa 1)', 'edadInicioAdv', 25, 'Tu edad actual para comenzar la primera etapa de ahorro'],
            ['Aporte mensual etapa 1', 'aporteTramo1', 1200, 'Cuánto planeas ahorrar mensualmente en tus primeros años (ej: 25-35 años)'],
            ['Edad inicio etapa 2', 'edadCambio1Adv', 35, 'Edad en que cambiarás tu estrategia de ahorro (ej: cuando tengas mejor sueldo)'],
            ['Aporte mensual etapa 2', 'aporteTramo2', 1500, 'Nuevo monto mensual en la segunda etapa (ej: 35-50 años)'],
            ['Edad etapa 3', 'edadCambio2Adv', 50, 'Edad para la tercera etapa (ej: cuando estés en tu mejor momento económico)'],
            ['Aporte mensual etapa 3', 'aporteTramo3', 1800, 'Monto mensual en la etapa final antes del retiro (ej: 50-65 años)'],
            ['Edad objetivo', 'edadFinAdv', 65, 'Edad en la que planeas jubilarte o necesitar el dinero'],
            ['Rendimiento anual (%)', 'rendimientoAdv', 5, 'Rentabilidad promedio anual esperada de tus inversiones'],
            ['Inflación anual (%)', 'inflacionAdv', 3, 'Inflación promedio anual esperada (reduce el poder adquisitivo)'],
        ];

        // --- SECCIÓN DE UTILIDADES ---
        function formatearNumero(numero) {
            return Math.round(numero).toLocaleString('es-ES', { minimumFractionDigits: 0 });
        }
        
        function formatearPorcentaje(numero) {
            return (Math.round(numero * 100) / 100).toLocaleString('es-ES', { minimumFractionDigits: 2 });
        }

        function getStoredValue(id, defaultValue) {
            const storedValue = localStorage.getItem(id);
            return storedValue !== null ? storedValue : defaultValue;
        }
        
        /**
         * Calcula la Tasa Interna de Retorno (TIR) ajustada por inflación.
         * Se usa una aproximación.
         * @param {Array<{edad: number, saldo: number, totalAportado: number}>} datos - Los datos de saldo por edad.
         * @param {number} inflacion - Tasa de inflación.
         * @returns {number} TIR real en porcentaje.
         */
        function calcularTIRReal(datos, inflacion) {
            if (datos.length < 2) return 0;

            const AporteInicial = datos[0].totalAportado;
            const Anios = datos[datos.length - 1].edad - datos[0].edad;
            const MontoFinal = datos[datos.length - 1].saldo;
            const AporteAnualPromedio = (datos[datos.length - 1].totalAportado - AporteInicial) / Anios;

            // Simplificación: TRC = (Valor Final / Inversión Total) ^ (1/Años) - 1
            // Usamos el Monto Final Real (ajustado por inflación) para obtener el retorno real
            const MontoFinalReal = MontoFinal / Math.pow(1 + inflacion, Anios);
            
            // Si el aporte inicial es cero, usamos un cálculo de serie de pagos
            if (AporteInicial === 0 && AporteAnualPromedio > 0) {
                // Cálculo aproximado de Tasa de Retorno sobre una anualidad
                // Esto requiere métodos iterativos más complejos (como Newton-Raphson) que no implementaremos aquí.
                // En su lugar, usaremos el retorno nominal menos la inflación como aproximación de "Retorno Real"
                
                // Retorno Nominal Promedio Simple: (MontoFinal / (AporteInicial + AporteAnualPromedio * Anios)) ^ (1/Anios) - 1
                const AporteTotal = datos[datos.length - 1].totalAportado;
                const RetornoNominal = Math.pow(MontoFinal / AporteTotal, 1/Anios) - 1;
                
                // Usamos la Tasa de Rendimiento Real (TRC), que es aproximadamente:
                // ((1 + Rendimiento Nominal) / (1 + Inflación)) - 1
                // En este caso, el Rendimiento Nominal ya está ajustado a la TIR
                if(isNaN(RetornoNominal)) return 0;
                return (((1 + RetornoNominal) / (1 + inflacion)) - 1) * 100;
                
            } else if (AporteInicial > 0 && AporteAnualPromedio === 0) {
                 // Si solo hay un aporte inicial (no hay aportes periódicos), es fácil de calcular:
                 const RetornoRealSimple = Math.pow(MontoFinalReal / AporteInicial, 1 / Anios) - 1;
                 return RetornoRealSimple * 100;
            } else {
                // Caso general: Usamos una aproximación de la tasa de crecimiento compuesto promedio
                const RetornoNominal = ((MontoFinal / datos[0].saldo) ** (1/Anios) - 1);
                return (((1 + RetornoNominal) / (1 + inflacion)) - 1) * 100;
            }
        }

        /**
         * Calcula el retiro mensual constante que puede hacerse durante un número de años (tasa real).
         * Utiliza la fórmula del valor actual de una anualidad (PV of Annuity).
         * @param {number} saldoFinalReal - Monto final ajustado a la inflación (poder adquisitivo de hoy).
         * @param {number} rendimientoRealAnual - Tasa de rendimiento real anual (Rendimiento Nominal - Inflación).
         * @param {number} aniosRetiro - Número de años que durará el retiro.
         * @returns {number} Monto mensual constante (en poder adquisitivo de hoy).
         */
        function calcularRetiroMensual(saldoFinalReal, rendimientoRealAnual, aniosRetiro) {
            const r = (1 + rendimientoRealAnual) / (1 + 0) - 1; // Usamos la tasa real, por lo que la inflación es 0
            const r_mensual = Math.pow(1 + r, 1/12) - 1;
            const n_meses = aniosRetiro * 12;

            if (r_mensual <= 0) {
                // Si la tasa real es 0 o negativa, el retiro constante es Saldo / Meses.
                // Usamos 0.000001 como tasa mínima para evitar división por cero.
                if (r_mensual <= -0.005) { // Si es muy negativa, el retiro es solo el capital
                    return saldoFinalReal / n_meses;
                }
            }

            // Fórmula de pago (PMT) para el valor presente (PV): PMT = PV * [ r / (1 - (1 + r)^-n) ]
            // Donde PMT es el pago, PV es el saldo, r es la tasa y n es el número de períodos.
            const retiroAnual = saldoFinalReal * (r / (1 - Math.pow(1 + r, -aniosRetiro)));
            
            return retiroAnual / 12; // Retiro mensual
        }
        
        // --- SECCIÓN DE RENDERIZACIÓN DE LA UI ---
        function generarInputs(campos, formId) {
            const form = document.getElementById(formId);
            const targetElement = formId === 'formAvanzado' ? form.querySelector('.form-section:first-child') : form;
            
            targetElement.innerHTML = formId === 'formAvanzado' ? '<div class="form-section-title">Parámetros Principales</div>' : '';

            campos.forEach(([labelText, id, valor, tooltip]) => {
                const value = getStoredValue(id, valor);
                
                const div = document.createElement('div');
                div.className = 'form-input-group';
                
                let labelHTML = labelText;
                
                if (tooltip) {
                    labelHTML = `
                        <div class="tooltip-container">
                            ${labelText}
                            <div class="tooltip-icon">?</div>
                            <div class="tooltip">${tooltip}</div>
                        </div>
                    `;
                }
                
                div.innerHTML = `
                    <label for="${id}">${labelHTML}</label>
                    <input type="number" id="${id}" value="${value}">
                    <div id="error-${id}" class="error-message"></div>
                `;

                targetElement.appendChild(div);
            });
        }
        
        function addDeductionInput(edad = '', monto = '') {
            const container = document.getElementById('deductionsContainer');
            const div = document.createElement('div');
            div.className = 'deduction-item';
            div.innerHTML = `
                <div class="form-input-group">
                    <label>Edad del gasto</label>
                    <input type="number" class="deduction-age" value="${edad}" placeholder="Ej: 40" min="0">
                    <div class="error-message"></div>
                </div>
                <div class="form-input-group">
                    <label>Monto anual</label>
                    <input type="number" class="deduction-amount" value="${monto}" placeholder="Ej: 5000" min="0">
                    <div class="error-message"></div>
                </div>
                <button type="button" class="remove-deduction-btn">➖ Eliminar</button>
            `;
            container.appendChild(div);
            
            div.querySelector('.remove-deduction-btn').addEventListener('click', () => {
                div.remove();
                autoCalcular();
            });
            
            div.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => {
                    validarInputs(); // Revalidar después de un cambio en deducciones
                    autoCalcular();
                });
            });
        }

        function renderChart2D(datos, rendimiento) {
            const ctx = document.getElementById('savingChart').getContext('2d');
            const years = datos.map(d => d.edad);
            const nominalData = datos.map(d => d.saldo);
            const realData = datos.map(d => d.saldoReal);
            const aportadoData = datos.map(d => d.totalAportado);
            const finalAge = years[years.length - 1];

            if (window.myChart) {
                window.myChart.destroy();
            }
            
            const isDark = document.body.classList.contains('night');
            const gridColor = isDark ? 'rgba(148, 163, 184, 0.2)' : 'rgba(226, 232, 240, 0.8)';
            const textColor = isDark ? '#f1f5f9' : '#1e293b';

            // Plugin para la línea de 1 Millón (MEJORA 5)
            const millionLinePlugin = {
                id: 'millionLinePlugin',
                beforeDraw: (chart) => {
                    const millionValue = 1000000;
                    const yScale = chart.scales.y;
                    const millionY = yScale.getPixelForValue(millionValue);
                    
                    if (millionY < yScale.bottom && millionY > yScale.top) {
                        const ctx = chart.ctx;
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(yScale.left, millionY);
                        ctx.lineTo(yScale.right, millionY);
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = '#8b5cf6'; // Violeta
                        ctx.setLineDash([6, 6]);
                        ctx.stroke();
                        ctx.restore();
                        
                        // Etiqueta del millón
                        ctx.fillStyle = '#8b5cf6';
                        ctx.textAlign = 'right';
                        ctx.font = '14px Inter';
                        ctx.fillText('$1,000,000', yScale.right - 5, millionY - 10);
                    }
                }
            };
            
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Poder Adquisitivo Real',
                        data: realData,
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.2)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                    }, {
                        label: 'Saldo Nominal',
                        data: nominalData,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                    }, {
                        label: 'Total Aportado', // MEJORA 5: Añadir línea de Aportado
                        data: aportadoData,
                        borderColor: 'var(--aportado-color)', 
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: textColor, font: { family: 'Inter, "Segoe UI", sans-serif', size: 14 } }
                        },
                        title: {
                            display: true,
                            text: `Proyección de Ahorros hasta los ${finalAge} años (Rendimiento: ${rendimiento}%)`,
                            color: textColor,
                            font: { family: 'Inter, "Segoe UI", sans-serif', size: 20, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += `$${formatearNumero(context.parsed.y)}`; }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Edad', color: textColor, font: { family: 'Inter, "Segoe UI", sans-serif', size: 16, weight: 'bold' } },
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        y: {
                            title: { display: true, text: 'Saldo (en $)', color: textColor, font: { family: 'Inter, "Segoe UI", sans-serif', size: 16, weight: 'bold' } },
                            grid: { color: gridColor },
                            ticks: { color: textColor, callback: (value) => `$${formatearNumero(value)}` }
                        }
                    }
                },
                plugins: [millionLinePlugin] // Aplicar el plugin del millón
            });
        }

        function renderResultados(datos, totalAportadoFinal, rendimiento, inflacion) {
            const final = datos[datos.length - 1];
            const realFinal = final.saldoReal;
            const generadoPorInversion = final.saldo - totalAportadoFinal;
            
            // --- CÁLCULOS MEJORA 4 ---
            const aniosRetiro = 30; // 30 años de retiro
            const rendimientoRealAnual = (rendimiento - inflacion) / 100;
            const retiroMensualReal = calcularRetiroMensual(realFinal, rendimientoRealAnual, aniosRetiro);
            
            const tirReal = calcularTIRReal(datos, inflacion / 100);

            let edadAlMillon = 'No alcanzado';
            for (let i = 0; i < datos.length; i++) {
                if (datos[i].saldo >= 1000000) {
                    edadAlMillon = datos[i].edad;
                    break;
                }
            }
            // --- FIN CÁLCULOS MEJORA 4 ---

            const tabla = datos.map(d => {
                return `<tr><td>${d.edad}</td><td>$${formatearNumero(d.saldo)}</td><td>$${formatearNumero(d.saldoReal)}</td><td>$${formatearNumero(d.totalAportado)}</td></tr>`;
            }).join('');
            
            document.getElementById('tableContainer').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Edad</th>
                            <th>Saldo Nominal</th>
                            <th>Poder Adquisitivo (Real)</th>
                            <th>Total Aportado</th>
                        </tr>
                    </thead>
                    <tbody>${tabla}</tbody>
                </table>
            `;

            renderChart2D(datos, rendimiento);

            document.getElementById('resumen').innerHTML = `
                <div class="resume-grid">
                    <div class="resume-item">
                        <h3>🎯 Monto Final</h3>
                        <div class="value">$${formatearNumero(final.saldo)}</div>
                        <div class="subtitle">A los ${final.edad} años (nominal)</div>
                    </div>
                    
                    <div class="resume-item" data-highlight="true">
                        <h3>💸 Retiro Mensual Sostenible</h3>
                        <div class="value">$${formatearNumero(retiroMensualReal)}</div>
                        <div class="subtitle">Mensual por ${aniosRetiro} años (Poder adquisitivo de hoy)</div>
                    </div>
                    
                    <div class="resume-item">
                        <h3>💪 Poder Adquisitivo</h3>
                        <div class="value">$${formatearNumero(realFinal)}</div>
                        <div class="subtitle">Equivalente a dinero de hoy</div>
                    </div>
                    
                    <div class="resume-item">
                        <h3>📈 Generado por Inversión</h3>
                        <div class="value">$${formatearNumero(generadoPorInversion)}</div>
                        <div class="subtitle">vs $${formatearNumero(totalAportadoFinal)} aportados</div>
                    </div>
                    
                    <div class="resume-item">
                        <h3>📊 TIR Real Anual</h3>
                        <div class="value">${formatearPorcentaje(tirReal)}%</div>
                        <div class="subtitle">Ganancia anual real (ajustada a inflación)</div>
                    </div>
                </div>
            `;
        }

        // --- SECCIÓN DE CÁLCULOS ---
        function getDeductions() {
            const deductions = {};
            document.querySelectorAll('.deduction-item').forEach(item => {
                const age = parseInt(item.querySelector('.deduction-age').value);
                const amount = parseFloat(item.querySelector('.deduction-amount').value);
                if (!isNaN(age) && !isNaN(amount) && amount > 0) {
                    deductions[age] = (deductions[age] || 0) + amount; 
                }
            });
            return deductions;
        }
        
        // MEJORA 6: Función de validación de entradas
        function validarInputs() {
            let isValid = true;
            const tab = document.querySelector('.tab.active').dataset.tab;
            const formId = tab === 'basico' ? 'formBasico' : 'formAvanzado';
            const inputs = document.querySelectorAll(`#${formId} input[type="number"]`);

            // Limpiar errores previos
            inputs.forEach(input => {
                input.removeAttribute('data-error');
                const errorDiv = document.getElementById(`error-${input.id}`) || input.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('error-message')) {
                    errorDiv.textContent = '';
                }
            });
            
            // 1. Validaciones generales de rangos y números
            inputs.forEach(input => {
                const value = parseFloat(input.value);
                if (isNaN(value) || input.value.trim() === '') {
                    isValid = false;
                    input.setAttribute('data-error', 'true');
                    const errorDiv = document.getElementById(`error-${input.id}`) || input.nextElementSibling;
                    if (errorDiv && errorDiv.classList.contains('error-message')) {
                        errorDiv.textContent = 'Este campo es obligatorio y debe ser un número.';
                    }
                } else if (input.id.includes('rendimiento') && value < -20) {
                    isValid = false;
                    input.setAttribute('data-error', 'true');
                    const errorDiv = document.getElementById(`error-${input.id}`) || input.nextElementSibling;
                    if (errorDiv && errorDiv.classList.contains('error-message')) {
                        errorDiv.textContent = 'El rendimiento no debe ser inferior a -20%.';
                    }
                }
            });

            if (!isValid) return false;

            // 2. Validaciones de Edades (Basico)
            if (tab === 'basico') {
                const e0 = +document.getElementById('edadInicioBasico').value;
                const eF = +document.getElementById('edadFinBasico').value;
                
                if (eF <= e0) {
                    isValid = false;
                    document.getElementById('edadFinBasico').setAttribute('data-error', 'true');
                    document.getElementById('error-edadFinBasico').textContent = 'La edad fin debe ser mayor a la edad inicio.';
                }
            }

            // 3. Validaciones de Edades (Avanzado)
            if (tab === 'avanzado') {
                const e0 = +document.getElementById('edadInicioAdv').value;
                const e1 = +document.getElementById('edadCambio1Adv').value;
                const e2 = +document.getElementById('edadCambio2Adv').value;
                const eF = +document.getElementById('edadFinAdv').value;
                
                // e1 > e0
                if (e1 <= e0) {
                    isValid = false;
                    document.getElementById('edadCambio1Adv').setAttribute('data-error', 'true');
                    document.getElementById('error-edadCambio1Adv').textContent = 'Debe ser mayor que la edad actual.';
                }
                
                // e2 > e1
                if (e2 <= e1) {
                    isValid = false;
                    document.getElementById('edadCambio2Adv').setAttribute('data-error', 'true');
                    document.getElementById('error-edadCambio2Adv').textContent = 'Debe ser mayor que la edad de inicio de etapa 2.';
                }
                
                // eF > e2
                if (eF <= e2) {
                    isValid = false;
                    document.getElementById('edadFinAdv').setAttribute('data-error', 'true');
                    document.getElementById('error-edadFinAdv').textContent = 'Debe ser mayor que la edad de etapa 3.';
                }
            }
            
            return isValid;
        }

        function calcularBasico() {
            if (!validarInputs()) return;
            
            const e0 = +document.getElementById('edadInicioBasico').value;
            const eF = +document.getElementById('edadFinBasico').value;
            const aporteMensual = +document.getElementById('aporteMensualBasico').value;
            const rendimiento = +document.getElementById('rendimientoBasico').value;
            const inflacion = +document.getElementById('inflacionBasico').value;
            
            const r_anual = rendimiento / 100;
            const i_anual = inflacion / 100;
            let saldo = +document.getElementById('montoInicialBasico').value;
            
            const datos = [];
            let totalAportado = saldo; 
            const aporteAnual = aporteMensual * 12;

            
            for (let edad = e0; edad <= eF; edad++) {
                const real = saldo / Math.pow(1 + i_anual, edad - e0);
                
                datos.push({ edad, saldo, saldoReal: real, totalAportado });

                if (edad === eF) break;
                
                saldo += aporteAnual;
                totalAportado += aporteAnual;
                
                saldo *= (1 + r_anual);
            }
            
            renderResultados(datos, totalAportado, rendimiento, inflacion);
        }

        function calcularAvanzado() {
            if (!validarInputs()) return;
            
            const e0 = +document.getElementById('edadInicioAdv').value;
            const e1 = +document.getElementById('edadCambio1Adv').value;
            const e2 = +document.getElementById('edadCambio2Adv').value;
            const eF = +document.getElementById('edadFinAdv').value;
            const a1 = +document.getElementById('aporteTramo1').value * 12;
            const a2 = +document.getElementById('aporteTramo2').value * 12;
            const a3 = +document.getElementById('aporteTramo3').value * 12;
            const rendimiento = +document.getElementById('rendimientoAdv').value;
            const inflacion = +document.getElementById('inflacionAdv').value;
            
            const r_anual = rendimiento / 100;
            const i_anual = inflacion / 100;
            let saldo = +document.getElementById('montoInicialAdv').value;

            const deducciones = getDeductions();
            
            const datos = [];
            let totalAportado = saldo;
            
            for (let edad = e0; edad <= eF; edad++) {
                
                const real = saldo / Math.pow(1 + i_anual, edad - e0);
                datos.push({ edad, saldo, saldoReal: real, totalAportado });

                if (edad === eF) break;
                
                let aporteAnual = 0;
                
                if (edad < e1) {
                    aporteAnual = a1;
                } else if (edad < e2) {
                    aporteAnual = a2;
                } else {
                    aporteAnual = a3;
                }
                
                saldo += aporteAnual;
                totalAportado += aporteAnual;
                
                if (deducciones[edad]) {
                    saldo -= deducciones[edad];
                }
                
                saldo *= (1 + r_anual);
            }
            
            renderResultados(datos, totalAportado, rendimiento, inflacion);
        }

        function autoCalcular() {
            // Guardar solo si estamos en un cambio de input, pero calcular solo si la validación pasa.
            // La validación se ejecuta dentro de calcularBasico/Avanzado.
            
            // 1. Guardar todos los valores (incluyendo errores)
            document.querySelectorAll('input[type="number"]').forEach(input => {
                localStorage.setItem(input.id, input.value);
            });
            
            const deductionsArray = [];
            document.querySelectorAll('.deduction-item').forEach(item => {
                const age = item.querySelector('.deduction-age').value;
                const amount = item.querySelector('.deduction-amount').value;
                if (age && amount) {
                    deductionsArray.push({ age, amount });
                }
            });
            localStorage.setItem('deductionsAdv', JSON.stringify(deductionsArray));

            // 2. Calcular solo si no hay errores graves (la validación interna maneja el flujo)
            const tab = document.querySelector('.tab.active').dataset.tab;
            if (tab === 'basico') {
                calcularBasico();
            } else {
                calcularAvanzado();
            }
        }
        
        function cambiarPestana(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            autoCalcular();
        }

        // --- SECCIÓN DE EVENT LISTENERS Y SETUP ---

        function setupEventListeners() {
            // Botones de control
            document.getElementById('toggleTableBtn').addEventListener('click', () => {
                const cont = document.getElementById('tableContainer');
                const visible = cont.style.display !== 'none';
                cont.style.display = visible ? 'none' : 'block';
                document.getElementById('toggleTableBtn').textContent = visible ? '👁️ Mostrar tabla' : '👁️ Ocultar tabla';
            });

            // Toggle Night Mode
            document.getElementById('toggleNightBtn').addEventListener('click', () => {
                const isDark = document.body.classList.toggle('night');
                localStorage.setItem('nightMode', isDark);
                document.getElementById('toggleNightBtn').textContent = isDark ? '☀️ Modo día' : '🌙 Modo noche';
                autoCalcular(); // Recalcular para actualizar colores del gráfico
            });
            
            // Botón de añadir deducción
            document.getElementById('addDeductionBtn').addEventListener('click', () => {
                addDeductionInput();
                autoCalcular();
            });

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    cambiarPestana(tab.dataset.tab);
                });
            });

            // Event listener único para inputs principales
            document.getElementById('formBasico').addEventListener('input', autoCalcular);
            document.getElementById('formAvanzado').querySelector('.form-section:first-child').addEventListener('input', autoCalcular);

            // Cargar listeners para inputs de deducciones al inicio
            document.querySelectorAll('.deduction-item input').forEach(input => {
                input.addEventListener('input', () => {
                    validarInputs(); 
                    autoCalcular();
                });
            });
        }

        // --- SECCIÓN DE INICIALIZACIÓN ---
        function init() {
            generarInputs(camposBasico, 'formBasico');
            generarInputs(camposAvanzado, 'formAvanzado');
            
            // Cargar y generar deducciones guardadas
            const storedDeductions = localStorage.getItem('deductionsAdv');
            const deductionsContainer = document.getElementById('deductionsContainer');
            deductionsContainer.innerHTML = ''; 
            
            if (storedDeductions && JSON.parse(storedDeductions).length > 0) {
                JSON.parse(storedDeductions).forEach(d => {
                    addDeductionInput(d.age, d.amount);
                });
            } else {
                // Valores por defecto
                addDeductionInput(30, 20000);
                addDeductionInput(45, 50000);
            }

            // Inicializar el modo noche si estaba activo
            if (localStorage.getItem('nightMode') === 'true') {
                 document.body.classList.add('night');
                 document.getElementById('toggleNightBtn').textContent = '☀️ Modo día';
            }
            
            setupEventListeners();
            
            // Primer cálculo al cargar la página
            autoCalcular();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
